{% extends 'base.html' %}
{% block content %}
<body class="bg-gray-100 dark:text-steel text-[#222222]">
    <!-- Blog Post Wrapper -->
    <div class="max-w-screen-md px-4 py-8 mx-auto">
        <!-- Thinner Centered Bar -->
        <div class="dark:bg-[#444444] bg-[#CCCCCC] rounded-3xl shadow-2xl dark:shadow-white p-6 mx-auto">
            <!-- Title Section -->
            <div class="text-center">
                <h1 class="text-6xl font-extrabold leading-tight text-cs-green">
                    Lab 4: CPSR and Literal Pools
                </h1>
                <h2 class="text-2xl text-bold leading-tight text-cs-green">
                    Title says it all
                </h1>
                 <!-- Separator -->
                <div class="h-px bg-cs-green my-6"></div>
                <a href="#overview" class="inline-block bg-cs-blue hover:bg-blue-700  hover:underline px-4 py-1 rounded-lg font-medium transition-all duration-300 border-[#333333] border">
                    Overview
                </a> >>
                <a href="#cpsr" class="inline-block bg-cs-blue hover:bg-blue-700 hover:underline px-4 py-1 rounded-lg font-medium transition-all duration-300 border-[#333333] border">
                    CPSR
                </a> >>
                <a href="#lp" class="inline-block bg-cs-blue hover:bg-blue-700 hover:underline px-4 py-1 rounded-lg font-medium transition-all duration-300 border-[#333333] border">
                    Literal Pools
                </a> >>
                <a href="#conclusion" class="inline-block bg-cs-blue hover:bg-blue-700 hover:underline px-4 py-1 rounded-lg font-medium transition-all duration-300 border-[#333333] border">
                    Conclusion
                </a> >>
                <a href="#assignment" class="inline-block bg-cs-blue hover:bg-blue-700 hover:underline px-4 py-1 rounded-lg font-medium transition-all duration-300 border-[#333333] border">
                    Assignment
                </a>
            </div>

            <!-- Blog Content -->
            <div class="h-px bg-cs-green my-6"></div><h1 id="overview" class="text-4xl font-extrabold">Overview</h1><br/>
            <p class="leading-relaxed text-lg">Welcome to Lab 4. Last lab, you learned about loading and storing data inthe memory of your microcontroller. Today, you will learn about the CPSR and literal pools and how these are handled in your ARM processor. This will be a shorter lab, so enjoy the break!</p><br/>
            
            <p class="leading-relaxed text-lg">All labs require a lab report. For a comprehensive look on what the TAs are looking for, formatting, and scoring, take a look at the <a href="lab-guide" class="text-lg text-cs-blue hover:text-blue-700 underline">Lab Report Guide</a>.</p><br/>
            
            <p class="leading-relaxed text-lg">These lab guides are handmade, and as such may contain errors in logic, spelling, grammar, etc. If you find any issues, please leave a note in the Feedback tab on the right so we can fix it ASAP. This tab can also be used to anonymously submit suggestions, improvements, or complaints about the website. All of these will be reviewed and taken into consideration.</p><br/>
            
            <div class="h-px bg-cs-green my-6"></div><h1 id="cpsr" class="text-4xl font-extrabold">CPSR</h1><br/>
            <p class="leading-relaxed text-lg">The CPSR, or Current Program Status Register, is a register in you ARM microcontroller that keeps track of certain processes while the program runs. This behavior allows for some very unique solutions to problems, but you first must understand how to use it. While the CPSR contains 32 bits of information, we will only look at the first four in this class, also known as the Condition Codes. These are NZCV, in that order. They stand for Negative, Zero, Carry, and oVerflow, respectively.</p><br/>
            
            <p class="leading-relaxed text-lg">These flags can be set by any command in ARM, and the bits are set based on the result. Assume we add the numbers 10 and -10. The result will be Zero, and no carry/overflow occured, so the NZCV bits will be set to 0100. If we add 4 and -8, the result is -4, so the NZCV bits are 1000. Let's pretend we are in a 4-bit, unsigned system. If we add 0b1111 (15) with 0b1000 (8), we get 0b0111 (7). This is because the leftmost bit gets carried and there is no space for it in the 4-bit system. Thus, the NZCV bits of this example would be 0010.</p><br/>
            
            <p class="leading-relaxed text-lg">Wondering the difference between Carry and Overflow? If you are adding 2 numbers with the same sign and the result doesn't make sense (add two negatives and get a positive, etc), then it is a carry. If you are adding 2 numbers with different signs and teh result doesn't make sense (large positive number + small negative number = negative number, etc), then it is an overflow.</p><br/>
            
            <p class="leading-relaxed text-lg">Multiple bits can be set at the same time, too. In the same 4-bit system, what if we add 0b1111 (15) and 0b0001 (1). The result is 0b0000 (0) with a carry. So both the C bit and the Z bit are set. The CPSR flags would be 0110.</p><br/>
            
            <h2 class="text-2xl text-bold underline text-cs-green">How to set CPSR flags</h2>
            <p class="leading-relaxed text-lg">Some ARM commands automatically set CPSR flags when run. Others need to be set manually. To manually force the CPSR flags to be set, you add an "S" to the end of the command name. For example, if you want to set the condition codes when performing an ADD, you would write the command as ADDS. MOV and ADD are examples of commands you need to force set, and LDR is an example of a command that sets them automatically.</p><br/>
            
            <h2 class="text-2xl text-bold underline text-cs-green">How to view CPSR flags</h2>
            <p class="leading-relaxed text-lg">In the debugger, the CPSR register can be seen at the bottom of your register list when you run <code class="bg-cs-blue px-1 rounded shadow-lg text-base">i r</code> (it is a register, after all). NOTE: The 4 bits are the LEFTMOST four bits of the 32 bit register. If you see 0xb00000010, then the CPSR flags are 0xb, which is 0x1100 in binary, so N and Z are on. If you see the cpsr register as <code class="bg-cs-blue px-1 rounded shadow-lg text-base">0x10</code>, remember that those are the RIGHTMOST bits (leading zeros are removed), so the four CPSR bits are 0000.</p><br/>
            
            <div class="h-px bg-cs-green my-6"></div><h1 id="lp" class="text-4xl font-extrabold">Literal Pools</h1><br/>
            <p class="leading-relaxed text-lg">Remember Lab 2 where you were asked to put a 32 bit number into a register, and you had to shift+add+shift+add a million times? That's annoying to write and also inefficient. If only there were a better way to declare a 32 bit number and place it in a register.</p><br/>
            
            <p class="leading-relaxed text-lg">Boom. Literal Pools.</p><br/>
            
            <p class="leading-relaxed text-lg">A literal pool is a place in memory directly between your program code and the .data section with user defined memory locations. The pool is reserved (and only exists) for any declared numbers that are too big for an immediate value. What the microcontroller does is, when compiling, replaces the large number in your code with the address for the literal pool and then puts the value at that address into a register. Essentially, it performs a load (LDR). </p><br/>
            
            <p class="leading-relaxed text-lg">So, how does this magic work? Instead of saying <code class="bg-cs-blue px-1 rounded shadow-lg text-base">MOV R0, #0xFFFFFFFF</code>, which will throw an error on compile, you write <code class="bg-cs-blue px-1 rounded shadow-lg text-base">LDR R0, =0xFFFFFFFF</code>. Notice that there is an <code class="bg-cs-blue px-1 rounded shadow-lg text-base">=</code> instead of a <code class="bg-cs-blue px-1 rounded shadow-lg text-base">#</code>, and that the command is LDR instead of MOV. If you write it like this, then you only need one line to place a 32-bit number in a register.</p><br/>
            
            <div class="h-px bg-cs-green my-6"></div><h1 id="lplim" class="text-4xl font-extrabold">Literal Limitations</h1><br/>
            <p class="leading-relaxed text-lg">Literal pools are very helpful, but they do have limitations. When locating where a literal (the number you are loading) is, the code only knows the distance between the command and the memory location where the literal is held. So the ARM processor says "oh, the literal is 60 bytes down, I'll go there, get the number, then come back." It doesn't know the objective address.</p><br/>
            
            <p class="leading-relaxed text-lg">It does that because the address of the literal pool command is an immediate value, while memory addresses are too long to be used as an immediate value. An offset can fit. But only up to a certain amount.</p><br/>
            
            <p class="leading-relaxed text-lg">In the ARM processor in your microcontroller, that limitation is 4096 bytes. That means that if there is more than 4096 bytes between a command and it's literal (stored right before the .data section), then the compiler will throw an error when you run <code class="bg-cs-blue px-1 rounded shadow-lg text-base">make</code>.</p><br/>
            
            <p class="leading-relaxed text-lg">One way to add a bunch of bytes is with the <code class="bg-cs-blue px-1 rounded shadow-lg text-base">.fill</code> directive. The syntax for that is <code class="bg-cs-blue px-1 rounded shadow-lg text-base">.fill blocksize, numberofblocks, value</code>. This fills a section of memory with <code class="bg-cs-blue px-1 rounded shadow-lg text-base">numberofblocks</code> number of <code class="bg-cs-blue px-1 rounded shadow-lg text-base">blocksize</code> sized sections which all contain the number <code class="bg-cs-blue px-1 rounded shadow-lg text-base">value</code>. Note that blocksize must be <=8, and your value must fit in the blocksize.</p><br/>
            
            
            <div class="h-px bg-cs-green my-6"></div><h1 id="conclusion" class="text-4xl font-extrabold">Conclusion</h1><br/>
            <p class="leading-relaxed text-lg">Here, you reviewed and learned about the CPSR flags and how literal pools work in ARM. In future labs, you will see how both of these can be applied to do some really cool things. For now, enjoy the short lab and good luck on the assignments!</p><br/>
            
            <p class="leading-relaxed text-lg">It may take a minute to settle into these concepts, but know that there are plenty of resources available to you if you are confused. See either Dr. Camp's office hours or preferably the TA office hours for help with labs, homework, or general questions about the course. All that's left to do now is to write your lab report and submit it via Canvas sometime before your next lab session.</p><br/>
            
            <div class="h-px bg-cs-green my-6"></div><h1 id="assignment" class="text-4xl font-extrabold">Assignment</h1><br/>
            <p class="leading-relaxed text-lg">The assignment portion of the lab contains all instructions and requirements for your lab report. Any challenges or questions in the sections above were hypothetical and just for your practice. On your lab report, you only need to respond to the assignments in this section. Remember that you can check out the <a href="lab-guide" class="text-lg text-cs-blue hover:text-blue-700 underline">Lab Report Guide</a> to see the expectations the TAs have of your lab reports.</p><br/>
            
            <p class="leading-relaxed text-lg">You should perform all these tasks in a new, blank directory on your red pitaya. Feel free to reference previous labs or the <a href="cheat-sheet" class="text-lg text-cs-blue hover:text-blue-700 underline">Cheat Sheet</a> to refresh on old topics. All tasks should only include ARM instructions you have learned up to this point. Working ahead is fine, but you need to keep the tasks in the scope of the lessons. For questions on this (if something applies, etc), ask a TA.</p><br/>
            
            <h2 class="text-2xl text-bold underline text-cs-green">PICK TWO</h2>
            <p class="leading-relaxed text-lg">There are three tasks listed for you below. You can pick any two tasks to attempt for this lab. The unchosen one is available for you to practice or review, but is not required. Submitting all three tasks will not grant you extra credit.</p><br/>
            
            <p class="leading-relaxed text-lg">However, the TAs will still make comments and give feedback on all three tasks, if submitted. If you want to submit a third task for feedback, but do NOT want it to be considered for grading, you must mark it clearly in your lab report with the phrase "DO NOT SCORE." If no task is marked with this phrase, the TAs will roll a random number generator to decide which two tasks to score for your lab grade.</p><br/>
            
            <p class="leading-relaxed text-lg">Additionally, if you come up with a task that you think is of comparable challenge to the ones listed, you may pitch it to one of the TAs. If accepted, your task (bound by the requirements agreed upon by you and the TA) will count towards one of the PICK TWO tasks. The other tasks may be submitted for feedback following the same protocol listed in the paragraphs above.</p><br/>
            
            <h2 class="text-2xl text-bold underline text-cs-green">Task 1</h2>
            <p class="leading-relaxed text-lg">Write code that produces the compiler error "invalid literal constant: pool needs to be closer."</p><br/>
            
            <p class="leading-relaxed text-lg">Additional Requirements:</p>
            <p class="leading-relaxed text-lg">- None</p><br/>
            
            <p class="leading-relaxed text-lg">Assumptions:</p>
            <p class="leading-relaxed text-lg">- Your program does not need to perform any action.</p>
            <p class="leading-relaxed text-lg">- Your program will not be able to compile because of the error.</p><br/>
            
            <p class="leading-relaxed text-lg">Expected Outputs:</p>
            <p class="leading-relaxed text-lg">- A screenshot of the error message after you try to <code class="bg-cs-blue px-1 rounded shadow-lg text-base">make</code> the file.</p><br/>
            
            <h2 class="text-2xl text-bold underline text-cs-green">Task 2</h2>
            <p class="leading-relaxed text-lg">Write code that produces all CPSR flags at least once when adding a number to your student ID.</p><br/>
            
            <p class="leading-relaxed text-lg">Additional Requirements:</p>
            <p class="leading-relaxed text-lg">- Your student ID must be loaded in a register using a literal pool.</p><br/>
            
            <p class="leading-relaxed text-lg">Assumptions:</p>
            <p class="leading-relaxed text-lg">- The number you add to your student ID is up to you, and you can change it as needed to get the correct flags.</p>
            <p class="leading-relaxed text-lg">- Multiple bits can be set at any given time and can count for multiple examples. E.x. getting the CPSR values 0110 will count as both your Z and C bits.</p>
            <p class="leading-relaxed text-lg">- All CPSR bits needs to be '1' at some point, and you can use as many programs/screenshots needed to show this occurring.</p>
            <p class="leading-relaxed text-lg">- You can view the CPSR bits using the debugger.</p>
            <p class="leading-relaxed text-lg">- You can do all the examples in a single program or update the file with new numbers for each example.</p><br/>
            
            <p class="leading-relaxed text-lg">Expected Outputs:</p>
            <p class="leading-relaxed text-lg">- One or more screenshots showing each CPSR bit set at least once, as well as the number you added to your ID to get that result.</p><br/>
            
            <h2 class="text-2xl text-bold underline text-cs-green">Task 3</h2>
            <p class="leading-relaxed text-lg">Find the memory address of a literal in your code.</p><br/>
            
            <p class="leading-relaxed text-lg">Additional Requirements:</p>
            <p class="leading-relaxed text-lg">- You cannot use a tag to mark the start of the literal pool.</p><br/>
            
            <p class="leading-relaxed text-lg">Assumptions:</p>
            <p class="leading-relaxed text-lg">- Your code includes at least one line that loads a number into a register using the literal pool.</p>
            <p class="leading-relaxed text-lg">- The result will have the memory address held in a register.</p>
            <p class="leading-relaxed text-lg">- You can choose which literal's address to find if you have more than one in your code.</p><br/>
            
            <p class="leading-relaxed text-lg">Expected Outputs:</p>
            <p class="leading-relaxed text-lg">- You should use the debugger to list the address of the literal contained in a register with <code class="bg-cs-blue px-1 rounded shadow-lg text-base">i r</code> and display the content of that memory address with an <code class="bg-cs-blue px-1 rounded shadow-lg text-base">x</code> command to show that it really does contain the literal.</p><br/>
            

            

        </div></div>
        <!-- Feedback Box -->
    <div id="feedback-box" class="fixed hidden right-0 top-1/2 transform -translate-y-1/2 bg-gray-200 dark:bg-[#444444] border-l-4 border-b-4 border-[#E0E0E0] dark:border-[#3B3B3B] rounded-l-xl shadow-lg w-64 p-4 z-50">
        <h2 class="font-bold text-lg dark:text-white text-gray-800 mb-2 text-center">Feedback</h2>
        <textarea id="feedback-text" class="w-full p-2 border rounded-md dark:bg-[#333333] dark:text-steel text-gray-800" rows="4" placeholder="Feedback, corrections, feature ideas, comments, etc."></textarea>
        <button id="submit-feedback" class="mt-2 w-full bg-cs-blue hover:bg-cs-green text-white py-2 px-4 rounded-md">Submit</button>
    </div>

    <!-- Toggle Tab -->
    <button id="feedback-toggle" class="fixed top-1/2 transform -translate-y-1/2 right-0 md:right-64 bg-cs-blue hover:bg-cs-green text-steel rounded-l-md px-1 py-8 shadow-md">
        ||
    </button>

    <!--
    <body class="flex justify-center items-center h-screen bg-gray-100">
        <div class="bg-white p-6 rounded shadow-lg">
            <h1 class="text-2xl mb-4">Report a Problem</h1>
            <form action="/submit_workorder" method="post">
                <textarea name="issue" required class="border p-2 w-full rounded" placeholder="Describe your issue..."></textarea>
                <button type="submit" class="mt-2 bg-blue-500 text-white px-4 py-2 rounded">Submit</button>
            </form>
        </div>
    </body>
    -->

    <script>
        const feedbackBox = document.getElementById('feedback-box');
        const feedbackToggle = document.getElementById('feedback-toggle');
        const feedbackText = document.getElementById('feedback-text');
        const submitFeedback = document.getElementById('submit-feedback');
        
        function checkScreenSize() {
            const isLargerThanMD = window.matchMedia('(min-width: 768px)').matches;

            if (isLargerThanMD) {
                feedbackBox.classList.remove('hidden');
                feedbackToggle.classList.remove('right-0');
                feedbackToggle.classList.add('md:right-64', 'right-64'); // Move next to the feedback box
            } else {
                feedbackBox.classList.add('hidden');
                feedbackToggle.classList.remove('md:right-64', 'right-64');
                feedbackToggle.classList.add('right-0');
            }
        }

        // Initial check when the page loads
        checkScreenSize();

        // Listen for window resize events to detect screen size changes
        window.addEventListener('resize', checkScreenSize);

        // Collapse/Expand Feedback Box
        feedbackToggle.addEventListener('click', () => {
            feedbackBox.classList.toggle('hidden');
            // Adjust the position of the toggle tab
            if (feedbackBox.classList.contains('hidden')) {
                feedbackToggle.classList.remove('md:right-64', 'right-64');
                feedbackToggle.classList.add('right-0'); // Move to the far right
                feedbackBox.classList.remove('md:block');
            } else {
                feedbackToggle.classList.remove('right-0');
                feedbackToggle.classList.add('md:right-64', 'right-64'); // Move next to the feedback box
            }
        });

        // Submit Feedback Function
        const submitFeedbackHandler = () => {
            const feedback = feedbackText.value.trim();
            if (feedback) {
                fetch('/submit-feedback', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ feedback, url: "/" + window.location.pathname.split('/').pop() }), // Ensure `feedback` is a valid variable
            })
            .then(async response => {
                if (response.ok) {
                    // Clear the input and thank the user
                    feedbackText.value = ''; // Ensure `feedbackText` is defined
                    submitFeedback.innerText = 'Thank you!'; // Change the button text
                    submitFeedback.classList.remove('bg-cs-blue'); // Remove original color
                    submitFeedback.classList.add('bg-cs-green'); // Add new color (green for success)

                    setTimeout(() => {
                        submitFeedback.innerText = 'Submit'; // Revert the button text after 3 seconds
                        submitFeedback.classList.remove('bg-cs-green'); // Remove green color
                        submitFeedback.classList.add('bg-cs-blue');
                    }, 3000); // 3000ms = 3 seconds
                } else {
                    // Attempt to read the error message from the server
                    const errorData = await response.json();
                    alert(`Error submitting feedback: ${errorData.details || 'Unknown error occurred'}. Please provide these details to Cooper :)`);
                }
            })
            .catch(error => {
                // Log the error for debugging and notify the user
                console.error('Submission error:', error);
                alert('An error occurred. Please try again.');
            });
            }
        };

        // Submit Feedback on Button Click
        submitFeedback.addEventListener('click', submitFeedbackHandler);

        // Submit Feedback on CMD+Enter or CTRL+Enter
        feedbackText.addEventListener('keydown', (event) => {
            if ((event.metaKey || event.ctrlKey) && event.key === 'Enter') {
                submitFeedbackHandler();
            }
        });
    </script>
</body>
{% endblock %}


<!--
                <h2>Blockquote Example</h2>
                <blockquote class="border-l-4 border-cs-blue italic pl-4 text-cs-green">
                    "This is an example of a blockquote. It's perfect for highlighting important points or quotes."
                </blockquote>

                <h2>Code Snippet Example</h2>
                <p>
                    Below is an example of a simple Python function:
                </p>
                <pre class="dark:bg-gray-600 bg-gray-400 rounded-lg p-4 shadow-2xl overflow-auto">
                
                </pre>
def greet(name):
    return f"Hello, {name}!"

print(greet("World"))
                </pre>


<code class="bg-cs-blue px-1 rounded shadow-lg text-base">

</code>
-->
